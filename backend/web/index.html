<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DesktopAI Live Context</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="bg"></div>
    <main class="app">
      <header class="hero">
        <div>
          <p class="eyebrow">DesktopAI</p>
          <h1>Live Desktop Context</h1>
          <p class="subhead">Foreground window activity streaming locally from Windows → WSL2.</p>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
            <span id="theme-icon">&#9790;</span>
          </button>
          <span id="collector-status" class="collector-status disconnected" title="Windows collector status">
            <span class="collector-dot"></span>
            <span class="collector-label">Collector</span>
          </span>
          <button id="notification-bell" class="notification-bell" aria-label="Notifications">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
            <span id="notification-count" class="notification-badge" hidden>0</span>
          </button>
          <div id="notification-dropdown" class="notification-dropdown" hidden></div>
          <div class="status" id="status">connecting</div>
        </div>
      </header>

      <section class="grid top-grid">
        <article class="card avatar-card" id="avatar">
          <div class="card-header">
            <h2>Lightwave Avatar</h2>
            <span class="pill" id="voice-state">standby</span>
          </div>
          <div class="avatar-wrap">
            <canvas id="avatar-canvas" aria-label="3D lightwave avatar"></canvas>
          </div>
          <p class="meta" id="stt-status">Mic: not started</p>
        </article>

        <article class="card voice-card">
          <div class="card-header">
            <h2>Voice Control</h2>
            <span class="pill" id="voice-engine">local browser</span>
          </div>
          <div class="card-body">
            <p class="summary-text" id="voice-transcript">Transcript will appear here when listening.</p>
            <textarea
              id="voice-text"
              class="voice-text"
              rows="4"
              placeholder="Type text for TTS, or start listening to fill this automatically."
              aria-label="Voice text input"
            ></textarea>
            <div class="voice-controls">
              <button class="btn secondary" id="mic-btn">Start Listening</button>
              <button class="btn" id="speak-btn">Speak Text</button>
            </div>
          </div>
        </article>
      </section>

      <section class="card chat-section">
        <div class="card-header">
          <h2>Chat with DesktopAI</h2>
          <span class="pill" id="chat-conversation-title">New Conversation</span>
          <select id="personality-mode" class="personality-select" aria-label="Personality mode">
            <option value="assistant">Assistant</option>
            <option value="copilot">Co-pilot</option>
            <option value="operator">Operator</option>
          </select>
          <button class="btn secondary" id="chat-new-btn" style="margin-left:auto;padding:4px 12px;font-size:0.85rem;">New Chat</button>
          <span class="pill" id="chat-status">ready</span>
        </div>
        <div class="chat-container">
          <div class="chat-context-bar" id="chat-context-bar">
            <span class="context-indicator" id="chat-context-indicator">No desktop context</span>
          </div>
          <div class="chat-messages" id="chat-messages">
            <div class="chat-welcome" id="chat-welcome">
              <p>Ask me anything about your desktop, or tell me to do something.</p>
              <div class="chat-suggestions">
                <button class="chat-suggestion" data-message="What am I working on?">What am I working on?</button>
                <button class="chat-suggestion" data-message="Summarize my current activity">Summarize my activity</button>
                <button class="chat-suggestion" data-message="Draft a reply to this email">Draft email reply</button>
                <button class="chat-suggestion" data-message="Open Notepad and write a meeting summary">Open Notepad</button>
              </div>
            </div>
          </div>
          <div id="recipe-suggestions" class="recipe-suggestions"></div>
          <div class="chat-input-bar">
            <input type="text" id="chat-input" placeholder="Ask something or give a command…" aria-label="Chat message" />
            <button class="btn" id="chat-send-btn">Send</button>
          </div>
          <p class="kbd-hint">/ focus &middot; Ctrl+Enter send &middot; Esc clear &middot; Ctrl+Shift+X kill switch</p>
        </div>
      </section>

      <section class="grid">
        <article class="card" id="current">
          <div class="card-header">
            <h2>Current Window</h2>
            <span class="pill" id="current-app">—</span>
          </div>
          <div class="card-body">
            <p class="title" id="current-title">Waiting for events…</p>
            <p class="meta" id="current-meta">—</p>
            <p class="meta" id="current-category">Category: —</p>
            <p class="meta" id="current-idle">Status: —</p>
            <p class="meta" id="current-time">—</p>
          </div>
        </article>

        <article class="card agent-vision-card" id="agent-vision">
          <div class="card-header">
            <h2>Agent Vision</h2>
            <span class="pill" id="vision-status">offline</span>
          </div>
          <div class="card-body">
            <p class="vision-title" id="vision-window-title">No desktop context</p>
            <p class="meta" id="vision-process">Process: —</p>
            <p class="meta" id="vision-timestamp">Last update: —</p>
            <div class="vision-uia">
              <p class="vision-uia-label">UI Elements</p>
              <pre class="vision-uia-text" id="vision-uia-text">No UIA data available</pre>
            </div>
            <p class="meta" id="vision-screenshot-status">Screenshot: unavailable</p>
            <button class="btn secondary" id="vision-refresh-btn">Refresh</button>
          </div>
        </article>

        <article class="card" id="summary">
          <div class="card-header">
            <h2>Local Summary</h2>
            <span class="pill" id="ollama-status">checking…</span>
          </div>
          <div class="card-body">
            <p class="summary-text" id="summary-text">Ollama summary is optional. If available, click below.</p>
            <p class="meta" id="ollama-detail">Ollama diagnostics: pending</p>
            <div class="voice-controls">
              <select id="ollama-model-select" aria-label="Ollama model">
                <option value="">Model: loading…</option>
              </select>
              <button class="btn secondary" id="ollama-model-refresh-btn">Refresh Models</button>
              <button class="btn secondary" id="ollama-model-apply-btn">Apply Model</button>
              <button class="btn secondary" id="ollama-model-reset-btn">Use Config Model</button>
              <button class="btn secondary" id="ollama-probe-btn">Probe Model</button>
            </div>
            <p class="meta" id="ollama-model-meta">Ollama model: unknown</p>
            <p class="meta" id="ollama-probe-result">Probe: not run</p>
            <div class="voice-controls">
              <button class="btn" id="summary-btn" disabled>Summarize with Ollama</button>
              <button class="btn secondary" id="summary-read-btn">Read Summary</button>
            </div>
            <div class="runtime-readiness">
              <p class="meta" id="executor-status">Executor: checking…</p>
              <p class="meta" id="executor-preflight-result">Preflight: not run</p>
              <button class="btn secondary" id="executor-preflight-btn">Run Executor Preflight</button>
              <ul class="events runtime-checks" id="executor-preflight-checks"></ul>
              <div class="voice-controls">
                <select id="planner-mode-select" aria-label="Autonomy planner mode">
                  <option value="deterministic">Planner: deterministic</option>
                  <option value="auto">Planner: auto</option>
                  <option value="ollama_required">Planner: ollama_required</option>
                </select>
                <button class="btn secondary" id="planner-mode-apply-btn">Apply Planner Mode</button>
                <button class="btn secondary" id="planner-mode-reset-btn">Use Config Default</button>
              </div>
              <p class="meta" id="planner-mode-meta">Planner mode: unknown</p>
              <p class="meta" id="readiness-status-result">Readiness: not run</p>
              <button class="btn secondary" id="readiness-status-refresh-btn">Refresh Readiness</button>
              <ul class="events runtime-checks" id="readiness-status-checks"></ul>
            </div>
          </div>
        </article>

        <article class="card" id="autonomy">
          <div class="card-header">
            <h2>Autonomous Mode</h2>
            <span class="pill" id="autonomy-status">idle</span>
          </div>
          <div class="card-body">
            <p class="summary-text">
              Runs planner → executor → verifier continuously until completion or manual stop.
            </p>
            <textarea
              id="autonomy-objective"
              class="voice-text"
              rows="3"
              placeholder="Objective (example: Open Outlook, search for sender, draft and send reply)"
              aria-label="Autonomy objective"
            ></textarea>
            <div class="autonomy-controls">
              <label class="autonomy-field">
                Max iterations
                <input id="autonomy-max-iterations" type="number" min="1" max="500" value="24" />
              </label>
              <label class="autonomy-field">
                Parallel agents
                <input id="autonomy-parallel-agents" type="number" min="1" max="16" value="3" />
              </label>
              <label class="autonomy-field">
                Autonomy level
                <select id="autonomy-level" aria-label="Autonomy level">
                  <option value="supervised">Supervised</option>
                  <option value="guided">Guided</option>
                  <option value="autonomous">Autonomous</option>
                </select>
              </label>
            </div>
            <div class="voice-controls">
              <button class="btn" id="autonomy-start-btn">Start Run</button>
              <button class="btn secondary" id="autonomy-approve-btn" disabled>Approve Next</button>
              <button class="btn secondary" id="autonomy-cancel-btn" disabled>Cancel Run</button>
              <button class="btn secondary" id="readiness-gate-btn">Run Readiness Gate</button>
            </div>
            <p class="meta" id="autonomy-run-meta">Run: —</p>
            <p class="meta" id="readiness-gate-result">Readiness Gate: not run</p>
            <textarea
              id="readiness-matrix-objectives"
              class="voice-text"
              rows="3"
              placeholder="Readiness matrix objectives (one per line)"
              aria-label="Readiness matrix objectives"
            ></textarea>
            <div class="voice-controls">
              <button class="btn secondary" id="readiness-matrix-btn">Run Readiness Matrix</button>
            </div>
            <p class="meta" id="readiness-matrix-result">Readiness Matrix: not run</p>
            <ul class="events readiness-matrix-log" id="readiness-matrix-results"></ul>
            <ul class="events autonomy-log" id="autonomy-log"></ul>
          </div>
        </article>
      </section>

      <section class="card">
        <div class="card-header">
          <h2>Recent Events</h2>
          <span class="pill" id="event-count">0</span>
        </div>
        <div class="filters">
          <input
            type="search"
            id="event-search"
            placeholder="Search title, app, UIA hints…"
            aria-label="Search events"
          />
          <select id="event-category" aria-label="Filter by category">
            <option value="all">All categories</option>
            <option value="coding">Coding</option>
            <option value="docs">Docs</option>
            <option value="comms">Comms</option>
            <option value="web">Web</option>
            <option value="terminal">Terminal</option>
            <option value="meeting">Meeting</option>
          </select>
          <select id="event-type" aria-label="Filter by event type">
            <option value="all">All events</option>
            <option value="foreground">Foreground</option>
            <option value="idle">Idle</option>
            <option value="active">Active</option>
          </select>
        </div>
        <ul class="events" id="events"></ul>
      </section>

      <section class="card" id="journey-console">
        <div class="card-header">
          <h2>Journey Console</h2>
          <span class="pill" id="journey-event-count">0</span>
        </div>
        <p class="summary-text">
          Inspect real frontend telemetry as the user sees it. Select a session and review emitted UI events.
        </p>
        <div class="journey-controls">
          <select id="journey-session" aria-label="Telemetry session"></select>
          <button class="btn secondary" id="journey-refresh-btn">Refresh Journey</button>
        </div>
        <p class="meta" id="journey-meta">Session: —</p>
        <ul class="events journey-log" id="journey-events"></ul>
      </section>

      <section class="card" id="runtime-logs-console">
        <div class="card-header">
          <h2>Runtime Logs</h2>
          <span class="pill" id="runtime-log-count">0</span>
        </div>
        <p class="summary-text">
          Live backend log buffer for correlating UI behavior with server/runtime events.
        </p>
        <div class="journey-controls">
          <input
            type="search"
            id="runtime-logs-search"
            placeholder="Filter logs by text"
            aria-label="Runtime log search"
          />
          <select id="runtime-logs-level" aria-label="Runtime log level">
            <option value="">All levels</option>
            <option value="DEBUG">DEBUG</option>
            <option value="INFO">INFO</option>
            <option value="WARNING">WARNING</option>
            <option value="ERROR">ERROR</option>
            <option value="CRITICAL">CRITICAL</option>
          </select>
          <button class="btn secondary" id="runtime-logs-refresh-btn">Refresh Logs</button>
          <button class="btn secondary" id="runtime-logs-correlate-btn">Correlate Session</button>
          <button class="btn secondary" id="runtime-logs-clear-btn">Clear Logs</button>
        </div>
        <p class="meta" id="runtime-logs-meta">Logs: —</p>
        <ul class="events journey-log" id="runtime-logs"></ul>
      </section>
    </main>

    <script type="module" src="/static/app.js"></script>
  </body>
</html>
